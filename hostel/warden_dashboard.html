<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warden Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Style for the modal */
        #history-modal { transition: opacity 0.3s ease; }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Navbar -->
    <nav class="bg-white shadow-md">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <span class="font-bold text-xl text-blue-600">Warden Dashboard</span>
                </div>
                <div class="flex items-center">
                    <span id="welcome-message" class="text-gray-700 mr-4">Welcome, Warden...</span>
                    <button id="logout-button" class="bg-red-500 text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-red-600">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto p-4 mt-8">
        
        <!-- Student Status List -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">All Student Status</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="student-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be inserted here by JavaScript -->
                        <tr id="loading-row">
                            <td colspan="4" class="px-6 py-4 text-center text-gray-500">Loading student data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Student History Modal -->
    <div id="history-modal" class="modal-overlay fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold">Student History</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            
            <!-- Scrollable History Table -->
            <div class="overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="modal-history-body" class="bg-white divide-y divide-gray-200">
                        <!-- History rows will be inserted here -->
                        <tr id="modal-loading-row">
                            <td colspan="3" class="px-6 py-4 text-center text-gray-500">Loading history...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <script>
        // --- GLOBALS ---
        const welcomeMessage = document.getElementById('welcome-message');
        const studentTableBody = document.getElementById('student-table-body');
        const loadingRow = document.getElementById('loading-row');
        
        // Modal elements
        const historyModal = document.getElementById('history-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalHistoryBody = document.getElementById('modal-history-body');
        const modalLoadingRow = document.getElementById('modal-loading-row');
        const closeModalBtn = document.getElementById('close-modal-btn');

        // --- HELPER FUNCTIONS ---

        /**
         * Populates the main student list table
         */
        function populateStudentTable(students) {
            // Clear loading row
            if (loadingRow) {
                loadingRow.remove();
            }
            
            // Clear existing data
            studentTableBody.innerHTML = '';

            if (students.length === 0) {
                studentTableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No students found.</td></tr>';
                return;
            }

            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${student.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            student.last_status === 'Check-In' ? 'bg-green-100 text-green-800' : 
                            (student.last_status === 'Check-Out' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800')
                        }">
                            ${student.last_status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="view-history-btn text-blue-600 hover:text-blue-800" data-id="${student.id}" data-name="${student.name}">
                            View History
                        </button>
                    </td>
                `;
                studentTableBody.appendChild(row);
            });
        }

        /**
         * Populates the modal's history table
         */
        function populateModalHistory(history) {
            // Clear loading row
            if (modalLoadingRow) {
                modalLoadingRow.remove();
            }
            
            // Clear existing history
            modalHistoryBody.innerHTML = '';

            if (history.length === 0) {
                modalHistoryBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No history found for this student.</td></tr>';
                return;
            }

            history.forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            log.status === 'Check-In' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                        }">
                            ${log.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${log.reason || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.timestamp}</td>
                `;
                modalHistoryBody.appendChild(row);
            });
        }
        
        /**
         * Shows the history modal and fetches data
         */
        async function showModal(studentId, studentName) {
            // Reset modal state
            modalTitle.textContent = `History for: ${studentName}`;
            modalHistoryBody.innerHTML = ''; // Clear old data
            modalHistoryBody.appendChild(modalLoadingRow); // Show loading
            
            // Show the modal
            historyModal.classList.remove('hidden');

            try {
                // --- THIS IS THE FIX ---
                // The typo 'studentIdT' has been corrected to 'studentId'
                const response = await fetch(`/hostel/api_get_student_history.php?student_id=${studentId}`);
                // --- END OF FIX ---
                
                const data = await response.json();
                
                if (data.success) {
                    populateModalHistory(data.history);
                } else {
                    throw new Error(data.message || 'Failed to load history.');
                }
            } catch (error) {
                console.error('Error fetching student history:', error);
                modalHistoryBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-red-500">Error: ${error.message}</td></tr>`;
            }
        }

        /**
         * Hides the history modal
         */
        function hideModal() {
            historyModal.classList.add('hidden');
        }

        // --- API CALLS ---

        /**
         * Checks the user's session
         */
        async function checkSession() {
            try {
                // Use a root-relative path
                const response = await fetch('/hostel/api_check_session.php');
                const data = await response.json();

                if (data.success && data.role === 'warden') {
                    welcomeMessage.textContent = `Welcome, ${data.name || 'Warden'}`;
                    // Session is valid, now fetch student list
                    fetchAllStudents();
                } else {
                    // Not logged in or not a warden
                    throw new Error(data.message || 'Not authenticated as warden.');
                }
            } catch (error) {
                console.error('Error checking session:', error);
                // Redirect to login
                window.location.href = '/hostel/login.html';
            }
        }

        /**
         * Fetches the list of all students
         */
        async function fetchAllStudents() {
            try {
                // Use a root-relative path
                const response = await fetch('/hostel/api_get_all_students_status.php');
                const data = await response.json();

                if (data.success) {
                    populateStudentTable(data.students);
                } else {
                    if (loadingRow) {
                        loadingRow.cells[0].textContent = `Error: ${data.message}`;
                        loadingRow.cells[0].classList.add('text-red-500');
                    }
                }
            } catch (error) {
                console.error('Error fetching students:', error);
                if (loadingRow) {
                    loadingRow.cells[0].textContent = 'Error: Failed to load student data.';
                    loadingRow.cells[0].classList.add('text-red-500');
                }
            }
        }

        // --- EVENT LISTENERS ---

        // On page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check session first
            checkSession();
        });

        // Logout button
        document.getElementById('logout-button').addEventListener('click', () => {
            // Use a root-relative path
            window.location.href = '/hostel/api_logout.php';
        });

        // Close modal button
        closeModalBtn.addEventListener('click', hideModal);
        
        // Close modal when clicking overlay (the modal itself)
        // FIX: The modal *is* the overlay, so we listen on it directly.
        historyModal.addEventListener('click', (e) => {
            // Only close if they clicked the overlay (the parent)
            // and not the content box inside it.
            if (e.target === historyModal) {
                hideModal();
            }
        });

        // Event delegation for "View History" buttons
        studentTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('view-history-btn')) {
                const button = e.target;
                const studentId = button.dataset.id;
                const studentName = button.dataset.name;
                showModal(studentId, studentName);
            }
        });

    </script>
</body>
</html>
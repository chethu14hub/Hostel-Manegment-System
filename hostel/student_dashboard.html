<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Style for the modal */
        #reason-modal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Navbar -->
    <nav class="bg-white shadow-md">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <span class="font-bold text-xl text-blue-600">Hostel Management</span>
                </div>
                <div class="flex items-center">
                    <span id="welcome-message" class="text-gray-700 mr-4">Welcome, ...</span>
                    <button id="logout-button" class="bg-red-500 text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-red-600">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto p-4 mt-8">
        
        <!-- Action Buttons -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Actions</h2>
            <div class="flex space-x-4">
                <button id="check-in-btn" class="flex-1 bg-green-500 text-white py-3 px-6 rounded-md font-medium hover:bg-green-600 transition duration-150">
                    Check-In
                </button>
                <button id="check-out-btn" class="flex-1 bg-yellow-500 text-white py-3 px-6 rounded-md font-medium hover:bg-yellow-600 transition duration-150">
                    Check-Out
                </button>
            </div>
            <div id="action-message" class="hidden mt-4 px-4 py-3 rounded-md" role="alert"></div>
        </div>

        <!-- Movement History -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">My Movement History</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be inserted here by JavaScript -->
                        <tr id="loading-row">
                            <td colspan="3" class="px-6 py-4 text-center text-gray-500">Loading history...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Check-Out Reason Modal -->
    <div id="reason-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Check-Out Details</h3>
            
            <div class="mb-4">
                <label for="checkout-reason" class="block text-sm font-medium text-gray-700 mb-2">Reason (Required)</label>
                <textarea id="checkout-reason" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Going home for the weekend"></textarea>
            </div>

            <!-- NEW: Manual Date/Time Input -->
            <div class="mb-6">
                <label for="checkout-time" class="block text-sm font-medium text-gray-700 mb-2">
                    Check-Out Time (Optional)
                </label>
                <p class="text-xs text-gray-500 mb-2">Leave blank to use the current time.</p>
                <input type="datetime-local" id="checkout-time" name="checkout-time" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="flex justify-end space-x-3">
                <button id="cancel-reason-btn" type="button" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md font-medium hover:bg-gray-400">
                    Cancel
                </button>
                <button id="submit-reason-btn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded-md font-medium hover:bg-blue-700">
                    Submit Check-Out
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- GLOBALS ---
        const welcomeMessage = document.getElementById('welcome-message');
        const historyTableBody = document.getElementById('history-table-body');
        const loadingRow = document.getElementById('loading-row');
        const actionMessage = document.getElementById('action-message');
        
        // Modal elements
        const reasonModal = document.getElementById('reason-modal');
        const checkoutReasonInput = document.getElementById('checkout-reason');
        const checkoutTimeInput = document.getElementById('checkout-time'); // New input
        const checkInBtn = document.getElementById('check-in-btn');
        const checkOutBtn = document.getElementById('check-out-btn');
        const cancelReasonBtn = document.getElementById('cancel-reason-btn');
        const submitReasonBtn = document.getElementById('submit-reason-btn');


        // --- HELPER FUNCTIONS ---

        /**
         * Displays a success or error message for actions (Check-In/Out)
         */
        function showActionMessage(message, isSuccess = true) {
            actionMessage.textContent = message;
            actionMessage.classList.remove('hidden');
            if (isSuccess) {
                actionMessage.classList.remove('bg-red-100', 'border-red-400', 'text-red-700');
                actionMessage.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
            } else {
                actionMessage.classList.remove('bg-green-100', 'border-green-400', 'text-green-700');
                actionMessage.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            }
        }

        /**
         * Hides the action message
         */
        function hideActionMessage() {
            actionMessage.classList.add('hidden');
        }

        /**
         * Populates the history table
         */
        function populateHistory(history) {
            // Clear loading row
            if (loadingRow) {
                loadingRow.remove();
            }
            
            // Clear existing history
            historyTableBody.innerHTML = '';

            if (history.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No movement history found.</td></tr>';
                return;
            }

            history.forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            log.status === 'Check-In' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                        }">
                            ${log.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${log.reason || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.timestamp}</td>
                `;
                historyTableBody.appendChild(row);
            });
        }
        
        /**
         * Shows the check-out modal
         */
        function showCheckoutModal() {
            checkoutReasonInput.value = ''; // Clear old reason
            checkoutTimeInput.value = '';   // Clear old time
            reasonModal.classList.remove('hidden');
        }

        /**
         * Hides the check-out modal
         */
        function hideCheckoutModal() {
            reasonModal.classList.add('hidden');
        }

        // --- API CALLS ---

        /**
         * Checks the user's session
         */
        async function checkSession() {
            try {
                // Use a root-relative path
                const response = await fetch('/hostel/api_check_session.php');
                const data = await response.json();

                if (data.success && data.role === 'student') {
                    welcomeMessage.textContent = `Welcome, ${data.name || 'Student'}`;
                    // Session is valid, now fetch history
                    fetchHistory();
                } else {
                    // Not logged in or not a student
                    throw new Error(data.message || 'Not authenticated');
                }
            } catch (error) {
                console.error('Error checking session:', error);
                // Redirect to login
                window.location.href = '/hostel/login.html';
            }
        }

        /**
         * Fetches the student's movement history
         */
        async function fetchHistory() {
            try {
                // Use a root-relative path
                const response = await fetch('/hostel/api_get_student_history.php');
                const data = await response.json();

                if (data.success) {
                    populateHistory(data.history);
                } else {
                    if (loadingRow) {
                        loadingRow.cells[0].textContent = `Error: ${data.message}`;
                        loadingRow.cells[0].classList.add('text-red-500');
                    }
                }
            } catch (error) {
                console.error('Error fetching history:', error);
                if (loadingRow) {
                    loadingRow.cells[0].textContent = 'Error: Failed to load history.';
                    loadingRow.cells[0].classList.add('text-red-500');
                }
            }
        }

        /**
         * Sends a check-in or check-out request to the API
         */
        async function logMovement(status, reason = null, checkoutTime = null) {
            hideActionMessage();
            try {
                // Construct the payload
                const payload = { status };
                if (reason) {
                    payload.reason = reason;
                }
                // UPDATED: Add checkoutTime to the payload if it exists
                if (checkoutTime) {
                    payload.checkoutTime = checkoutTime;
                }
                
                // Use a root-relative path
                const response = await fetch('/hostel/api_log_movement.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    showActionMessage(data.message, true);
                    // Refresh history to show the new log
                    fetchHistory();
                } else {
                    // --- THIS IS THE FIX ---
                    // Check if the error message is about authentication
                    if (data.message && (data.message.includes('authenticated') || data.message.includes('Unauthorized'))) {
                        // Session expired or invalid. Redirect to login.
                        showActionMessage('Session expired. Redirecting to login...', false);
                        setTimeout(() => {
                            window.location.href = '/hostel/login.html';
                        }, 2000);
                    } else {
                        // Show other errors normally (e.g., "Reason is required")
                        showActionMessage(`Error: ${data.message}`, false);
                    }
                    // --- END OF FIX ---
                }
            } catch (error) {
                console.error('Movement log error:', error);
                showActionMessage('A network error occurred. Please try again.', false);
            }
        }

        // --- EVENT LISTENERS ---

        // On page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check session first
            checkSession();
        });

        // Logout button
        document.getElementById('logout-button').addEventListener('click', () => {
            // Use a root-relative path
            window.location.href = '/hostel/api_logout.php';
        });

        // Check-In button
        checkInBtn.addEventListener('click', () => {
            logMovement('Check-In');
        });
        
        // Check-Out button (now shows modal)
        checkOutBtn.addEventListener('click', () => {
            showCheckoutModal();
        });

        // Modal Cancel button
        cancelReasonBtn.addEventListener('click', () => {
            hideCheckoutModal();
        });

        // Modal Submit button
        submitReasonBtn.addEventListener('click', () => {
            const reason = checkoutReasonInput.value;
            const checkoutTime = checkoutTimeInput.value; // Get the manual time
            
            if (!reason) {
                alert('Please provide a reason for checking out.');
                return;
            }
            
            // Hide the modal
            hideCheckoutModal();
            
            // Send the request with the reason and optional time
            logMovement('Check-Out', reason, checkoutTime);
        });

    </script>
</body>
</html>